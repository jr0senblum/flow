
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create</title>
    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-4"> 
          <div class="btn-group-sm">
	    <button id="usebutton" class="btn btn-sm" type="button" onclick="selectAsana()">
	      <em class="glyphicon glyphicon-link" ></em> 
	    </button>
	    <button id="undobutton" class="btn btn-sm" type="button" onclick="undo()">
	      <em  class="glyphicon glyphicon-step-backward" ></em>
	    </button>
	    <button  class="btn btn-sm" type="button" onclick="save()">
	      <em class="glyphicon glyphicon-save"></em>
            </button>
	    <button  class="btn btn-sm" type="button">
	      <a href="/"> <em class="glyphicon glyphicon-tasks"></em></a>
            </button>
          </div>
          <div>
            <a id="ename" class="text-left text-success">Starting</a>  
          </div>
          <div>
            <img id="pic" src="" onclick="restore()" heigth="75" width="75"></img>
          </div>
        </div>
        <div class="col-xs-3">
          <div>
            <select id="tos" data-placeholder="Next..."
                    class="select"> 
            </select>
          </div>
        </div>
        <div class="col-xs-5">
          <div class="btn-group-sm" style="float:right">
	    <button class="btn btn-sm" type="button">
	      <em class="glyphicon glyphicon-flash" ></em><span id="attS" ></span>
            </button>
	    <button class="btn btn-sm" type="button">
	      <em class="glyphicon glyphicon-object-align-vertical" ></em><span id="attB"></span>
            </button>
	    <button  class="btn btn-sm" type="button">
	      <em class="glyphicon glyphicon-menu-down" ></em><span id="attF"></span>
            </button>
          </div>
        </div>
      </div>


      <div class="row">
        <div class="col-xs-12">
          <div id='flowthusfar'>
            <ul  class="images">
            </ul>
          </div>
        </div>
      </div>

  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>


  <script>


$(document).ready(function() {
  loadAllAsana(0);
  setAtt();
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), true);
})



var asanas = new Array(); // array of all asanas
var current = 0;          // indext into asanas of current asana
var flow = [];           // Array of asana-ids of the flow being constructed
var G_swap = false;      // In swap mode?
var altOrigPos;
var nS = 0;
var nB = 0;
var nF = 0;


function save() {
  $.post("/create/save/{{id}}",
         {updated_flow:JSON.stringify(flow)},
         function(data,status) { });
}


// Load all asanas, load flow being edited (if one), set initial current state.
function loadAllAsana(index) {
  $.ajax("/create/asana/all",
         { cache: false,
           success: function(data, code, xhr) {
             asanas = data.asanas;
             current = -1;
             populateChoices(data.asanas, $("#tos"));
             load_flow() 
           }});

}

// Display the image of the current asana and its name.
function displayAsana() {
  $("#ename").text(asanas[current].name); 
  $("#pic").attr('src', "/static/stickfigures/" + asanas[current].name.toLowerCase() + ".jpg");
  getRelatedAsana();
}

// Fetch Asana previously selected after the current one.
function getRelatedAsana() {
  $.ajax("/create/related/" + asanas[current].id,
         { cache: false,
           success: function(data, code, xhr) {
             populateChoices(data.exits, $('#tos'))
         }})}

// Populate exiting or alternative asanas.
function populateChoices(choices, control) {
  var Rows = "</option><optgroup label='Previously linked'>";
  var Found = new Array();
  
  for (i = 0; i < choices.length; i++) {
    Rows = Rows + 
      '<option value="' + choices[i].id + '">'+ 
      choices[i].name + '</option>';
    Found.push(choices[i].id);
  };
  Rows = Rows + "</optgroup>"
  control.html(Rows);

  Rows = "<optgroup label='Not used'>";
  for (i = 0; i < asanas.length; i++) {
    if (Found.indexOf(asanas[i].id) == -1 && i != current) {
      Rows = Rows + 
        '<option value="' + asanas[i].id + '">' + 
        asanas[i].name + '</option>';
    }
  }
  Rows = Rows + "</optgroup>";
  control.append(Rows);
}

// make sure that the the horizonaal list of flow_thus_far shows the last asana.
function scrollToEnd() {
  var flow_list  = $("#flowthusfar ul");
  var width = flow_list[0].scrollWidth;
  if (flow_list) flow_list.scrollLeft(width)
}


// If this page is loaded with pre-exiting flow information, use it.
function load_flow() {
  {% if flow %}
   {% for f in flow %}
    load_asana_from_flow('{{f}}');
   {% endfor %}
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), flow.length < 2);
  scrollToEnd();
  {% endif %}
}

function load_asana_from_flow(asana_id) {
  var old_current = current;
  current = indexof(asana_id, asanas);
  updateAttCount(asanas[current], true);
  displayAsana();
  flow.push(asana_id);
  if (old_current > -1) {
    var oldHead = asanas[old_current];
    var oldHeadId = asanas[old_current].id;
    var Id = (flow.length - 1).toString();
    var Row = '<li id="' + Id + '">' +
        '<img src="/static/stickfigures/' + oldHead.name.toLowerCase() + '.jpg" onclick="backUp(\'' + Id + '\' )"></li>';  
    var List  = $("#flowthusfar ul");
    List.append(Row)
  }
}
         
function selectAsana() {           
  if (G_swap) { 
    swap() 
  } else { 
    use() 
  }
}

function use() {
  // If any image had been hightlighted, remove that highlight.
  $('img').removeClass('focused');

  var comp = $("#tos")[0];
  var new_asana_id = comp.options[comp.selectedIndex].value;
  var name = comp.options[comp.selectedIndex].text;

  var old_current = current;
  current = indexof(new_asana_id, asanas);

  updateAttCount(asanas[current],true);
  displayAsana();

  flow.push(new_asana_id);

  if (old_current > -1) {
    var oldHead = asanas[old_current];
    var oldHeadId = asanas[old_current].id;
    var Id = (flow.length - 1).toString();
    var Row = '<li id="' + Id + '">' +
      '<img src="/static/stickfigures/' + oldHead.name.toLowerCase() + '.jpg" onclick="backUp(\'' + Id + '\' )"></li>';  
    var List  = $("#flowthusfar ul");
    List.append(Row);
  };
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), flow.length < 2);
  scrollToEnd();
}


// the swap button was pressed, if a replacement has been selected... swap it.
function swap() {
  var comp = $("#tos")[0];
  var SelectedIndex = comp.selectedIndex;
  if (SelectedIndex > -1) {
    var newAsinaId = comp.options[SelectedIndex].value;
    var name = comp.options[SelectedIndex].text;

    if (newAsinaId != "") {                  
      // blank wasn't selected, replace the original in flow with the new
      flow[altOrigPos] = newAsinaId;
      recalcAtt();

      // update teh image and onclick attributes in the list of flow asanas
      var rowIndex = altOrigPos + 1;
      $("#"+rowIndex+" img").attr('src','/static/stickfigures/' + name.toLowerCase() + '.jpg')
      $("#"+rowIndex+" img").attr('onclick','backUp("'+rowIndex+'")');
    }
  }
}

// Clicking the staged asana resets all the button states - we are now in add asana mode.
function restore() {
  getRelatedAsana();
  $('img').removeClass('focused');

  // no swap, yes use, undo if we have a flow
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), flow.length < 2);

  scrollToEnd();
  G_swap = false
}

function indexof(identifier, inArray) {
  var found = inArray.findIndex(function(el,i,a) 
                               { if (el.id == identifier) {
                                 return true
                               } else { 
                                 return false
                               }
                               });
  return found
}


function undo() {
  var last_in_flow;
  last_in_flow = flow.pop();
  updateAttCount(asanas[indexof(last_in_flow, asanas)], false);
  current = indexof(flow[flow.length-1], asanas);
  
  $("#flowthusfar ul li:last").remove();
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), flow.length < 2);
  displayAsana()
}

// User selected a non-last asana, select it and load potential replacements.
function backUp(PosId) {
  G_swap=true;
  $('img').removeClass('focused');
  $('#' + PosId + ' img').addClass('focused');

  // record the position of the asana targted for replacement.
  altOrigPos=PosId-1;

  // only the sawp buttonis allowed
  setButtonDisabled($('#usebutton'), false);
  setButtonDisabled($('#undobutton'), true);

  // Flow member to the left, to the right and the one being targeted (middle).
  replacements(flow[PosId-2], flow[PosId], flow[PosId-1])
}

function replacements(Id, Id2, CurrentId) {
  $.ajax("/create/replacements/" + Id +"/"+Id2,
         { cache: false,
           success: function(data, code, xhr) {
             populateAlts(data.replacements, CurrentId)
         }})
}


// populate the select component with potential replacements
// add all other asanas
function populateAlts(Items, SelectedId) {
  var control = $("#tos");
  var Rows = "<option value=''></option><optgroup label='Previously linked'>";

  var Found = new Array();
  
  for (i = 0; i < Items.length; i++) {
    var S;
    if (Items[i].id == SelectedId) {S = " selected "} else {S = ""};
    Rows = Rows + 
      '<option value="' + Items[i].id + '" ' + S + '>'+ 
      Items[i].name + '</option>';
    Found.push(Items[i].id);
  };
  Rows = Rows + "</optgroup>"
  control.html(Rows);

  Rows = "<optgroup label='Not used'>";
  for (i = 0; i < asanas.length; i++) {
    if (Found.indexOf(asanas[i].id) == -1) {
    var S;
    if (asanas[i].id == SelectedId) {S = " selected "} else {S = ""};
      Rows = Rows + 
        '<option value="' + asanas[i].id + '" ' + S + '>' + 
        asanas[i].name + '</option>';
    }
  }
  Rows = Rows + "</optgroup>";
  control.append(Rows);

}


function recalcAtt() {
  nS=0; nB=0; nF=0;
  flow.forEach(function(Id, i) {
    var Index = indexof(Id, asanas);
    updateAttCount(asanas[Index], true)
    })
}

function updateAttCount(Asana, bAdd) {
  var offset;
  if (bAdd) {
    offset = 1
  } else {
    offset = -1
  };

  if (Asana.strength) {
    nS = nS + offset
  };
  if (Asana.ballance) {
    nB = nB + offset
  };
  if (Asana.flexibility) {
    nF = nF + offset
  };
  setAtt()
}

function setAtt() {
  $("#attS").text(nS);
  $("#attB").text(nB);
  $("#attF").text(nF)
}



// Button State Management
//

function setButtonState(state) {
  // change button state
  // state = true indicates button is off
  $("#usebutton").prop("disabled", false)
}

// Button State Management
//

function setButtonDisabled(button, state) {
  // change icon and text from save to saved and back again.
  // state = true indicates that everything has been saved.
  button.prop("disabled", state);
}




</script>
  </body>
</html>



