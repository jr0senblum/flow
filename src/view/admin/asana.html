<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Flow!</title>
    
    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">
    
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/chosen.min.css" rel="stylesheet">
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
	<div class="col-md-12">
          <div class="page-header">
            <nav class="navbar navbar-default " role="navigation">
	      <div class="navbar-header">
	        
	        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
		  <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
	        </button> <a class="navbar-brand" href="#">FLOW creative</a>
	      </div>
	      
	      <form class="navbar-form navbar-left" id="theSearchForm" role="search" action='javascript:void(0);'>
	        <div class="form-group">
		  <input type="text" class="form-control" />
	        </div> 
	        <button id="search" type="submit" class="btn btn-default" href="" onclick="gotoAsana()">
		  Search
	        </button>
	        <button id="clear" type="submit" class="btn btn-default" href="" onclick="clearSearch()">
		  Clear
	        </button>

	      </form>
	      <ul class="nav navbar-nav navbar-right">
	        <li class="dropdown">
		  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Flows<strong class="caret"></strong></a>
		  <ul class="dropdown-menu">
		    <li>
		      <a href="#">Load Flow</a>
		    </li>
		    <li>
		      <a href="#">Save Flow</a>
		    </li>
	          </ul>
	        </li>
              </ul>
	    </nav>
          
	</div>
      </div>
      <div class="row">
	<div class="col-md-12">
          <div class="col-md-4">
	    <h3 class="text-left text-info">Enters from...</h3>
            
            <select id="froms" data-placeholder="Choose asanas..." style="width:350px;" 
                    multiple class="chosen-select">
            </select>

	  </div>
	  <div class="col-md-4">
	  <h3 id="ename" class="text-left text-success"> </h3>
          <div class="btn-group">
	     <button class="btn btn-default" type="button" onclick="toggleAttribute('strength')">
	      <em id="strength" class={% if asana.strength %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Strength
	    </button>
	    <button class="btn btn-default" type="button" onclick="toggleAttribute('ballance')">
	      <em id="ballance" class={% if asana.ballance %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Ballance
	    </button>
	    <button  class="btn btn-default" type="button" onclick="toggleAttribute('flexibility')">
	      <em id="flexibility" class={% if asana.flexibility %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Flexibility
	    </button> 
	   </div>
          
           <div> <img id="pic"  alt="Asana Picture" src={{ path }}></div>
	   <div class="btn-group">
	     <button id="left" class="btn btn-default" type="button" onclick="previous()">
	       <em class="glyphicon glyphicon-chevron-left" ></em> Previous
	     </button>
	     <button id="right" class="btn btn-default" type="button" onclick="next()">
	       <em  class="glyphicon glyphicon-chevron-right" ></em> Next
	     </button>
	     <button id="reset" class="btn btn-default" type="button" onclick="reset()">
	       <em  class="glyphicon glyphicon-refresh" ></em> Reset
	     </button>
	     <button  id="savebutton"class="btn btn-default" type="button" onclick="saveCurrent()">
	       <em  id="save" class="glyphicon glyphicon-saved" ></em> Save
	     </button>
             
	   </div>
	</div>
        
        <div class="col-md-4">
          <div class="col-md-4">
	    <h3 class="text-left text-info"> Exits to...</h3>
            <select id="tos" data-placeholder="Choose asanas..." style="width:350px;" 
                    multiple class="chosen"> 
            </select>
          </div>
        </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
	<div class="row">            
	</div>
        <table id="mg" class="table table-condensed table-striped tableSection">
	  <thead>
	    <tr>
	      <th>
		Major Muscle Groups
	      </th>
	    </tr>
	  </thead>
	  <tbody> 
	  </tbody> 
	</table>
      </div>
      <div class="col-md-6">
        <div class="row">
	</div>
	<table id="rom" class="table table-condensed table-striped tableSection">
	  <thead>
	    <tr>
	      <th>
		Joints and Ranges
	      </th>
	      </tr>
	  </thead>
	  <tbody>
	  </tbody>
	</table>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
      </div>
    </div>
</div>


  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/chosen.jquery.min.js"></script>

  <script>

  $(document).ready(function() {
    loadAllAsana(0);
    setSaveButton(true);
  });


// Attach the Chosen jquery plug-in to the select-boxes.
$("#tos").chosen().change(function() {
     setSaveButton(false)
  })

$("#froms").chosen().change(function() {
     setSaveButton(false)
  })

// Asanas is the array of all asanas, current is the index of the current one.
var asanas = new Array();
var current = 0;



// Re/Loading Asana and related information.
//


// Reload the asana from the server and redisplay the current asana.
function reset() {
  loadAllAsana(current)
}


// Load all asana and set the current asana to be the index.
function loadAllAsana(index) {
  $.ajax("/admin/asana/all",
         { cache: false,
           success: function(data, code, xhr) {
             asanas = data.asanas;
             current = index;
             setSaveButton(true);
             displayAsana()
           }})
}


// Get related objects to the current asana.
function getDetails() {
  $.ajax("/admin/related/" + asanas[current].id,
         { cache: false,
           success: function(data, code, xhr) {
             populateAnatomy(data.mg, data.allmg, '#mg');
             populateAnatomy(data.rom, data.allrom, '#rom');
             populateEntersAndExits(data.enters, $('#froms'));
             populateEntersAndExits(data.exits, $('#tos'))
         }})}


// Populate either range of motion or musclegroup tables.
function populateAnatomy(groups, all, accessor) {
  var Rows = "";
  var Found = new Array();
  $(accessor + ' tbody').empty()
  for (i = 0; i < groups.length; i++) {
    Found.push(groups[i].id);
    Rows = Rows + 
      "<tr class='success' onclick='sel(this)'>" +
      "<td value='"+groups[i].id+"'>" + groups[i].name + " </td></tr>";
  };
  for (i = 0; i < all.length; i++) {
    if (Found.indexOf(all[i].id) == -1 ) {
      Rows = Rows + 
      "<tr class='active' onclick='sel(this)';>" +
      "<td value='"+all[i].id+"'>" + all[i].name + " </td></tr>";
    }
  }
  $(accessor + ' > tbody:last-child').append(Rows)
}


// Populate either entering or exiting asana select boxes.
function populateEntersAndExits(enters, control) {
  var Rows = "";
  var Found = new Array();
  
  for (i = 0; i < enters.length; i++) {
    Rows = Rows + 
      '<option value="' + enters[i].id + '" selected>' + 
      enters[i].name + '</option>';
    Found.push(enters[i].id);
  };
  control.html(Rows);

  Rows = "";
  for (i = 0; i < asanas.length; i++) {
    if (Found.indexOf(asanas[i].id) == -1 && i != current) {
      Rows = Rows + 
        '<option value="' + asanas[i].id + '">' + 
        asanas[i].name + '</option>';
    }
  }
  control.append(Rows);
  control.trigger("chosen:updated")
}



// Button State Management
//

function setSaveButton(state) {
  // change icon and text from save to saved and back again.
  // state = true indicates that everything has been saved.
  if (state == true) {
    $("#save").removeClass("glyphicon-save").addClass("glyphicon-saved")
  } else {
    $("#save").removeClass("glyphicon-saved").addClass("glyphicon-save");
  };
  $("#savebutton").prop("disabled", state);
  setNextPrevStatus()
}


function notAllSaved() {
  return $("#save").hasClass("glyphicon-save")
}


function setNextPrevStatus() {
  var all_saved = notAllSaved();
  toggleButtonStatus($('#right'), ((current == asanas.length - 1) || all_saved));
  toggleButtonStatus($('#left'), ((current == 0) || all_saved));
  toggleButtonStatus($("#search"), all_saved);
  toggleButtonStatus($("#clear"), all_saved)
}


function toggleButtonStatus(a_button, state) {
  a_button.prop("disabled", state)
}


function next() {
  if (current < asanas.length - 1) {
    current = current + 1;
    displayAsana();
  };
  setNextPrevStatus()
}

function previous() {
  if (current > 0) {
    current = current - 1;
    displayAsana();
  };
  setNextPrevStatus()
}



// Saving changes to an asana.
function saveCurrent() {
  var fs = collectTransitions($("#froms option"));
  var es = collectTransitions($("#tos option"));
  var mmg = collectAnatomy($("#mg tbody .success td"));
  var rom = collectAnatomy($("#rom tbody .success td"));

  $.post("/admin/asana/update",
         {new_asana:JSON.stringify(asanas[current]),
          from_asanas:JSON.stringify(fs),
          to_asanas:JSON.stringify(es),
          mmgs:JSON.stringify(mmg),
          roms:JSON.stringify(rom)},
         function(data,status) { });
  setSaveButton(true)
}

function collectTransitions(select) {
  var selected=[];
  for (var i = 0; i < select.length; i++) {
    if (select[i].selected) selected.push(select[i].value);
  }
  return (selected)
}

function collectAnatomy(rows) {
  var selected=[];
  for (var i = 0; i < rows.length; i++) {
    selected.push(rows[i].getAttribute("value"));
  }
  return (selected)
}
  












function sel(n) {
  var Component = $(n);
  if (Component.hasClass("success")) {
    Component.removeClass("success");
    Component.addClass("active")
  } else {
    Component.removeClass("active");
    Component.addClass("success")
  };
  setSaveButton(false);
}







function displayAsana() {
  $("#ename").text(asanas[current].name + " - " + asanas[current].sanskrit);
  setAttributeButton($("#strength"), asanas[current].strength); 
  setAttributeButton($("#ballance"), asanas[current].ballance); 
  setAttributeButton($("#flexibility"), asanas[current].flexibility)
  $("#pic").attr('src', "/static/stickfigures/" + asanas[current].name.toLowerCase() + ".jpg");
  getDetails();
}

function setAttributeButton(control, value) {
  if (value) {
    control.removeClass("glyphicon-remove");
    control.addClass("glyphicon-ok")
  } else {
    control.removeClass("glyphicon-ok");
    control.addClass("glyphicon-remove")
  }};


function toggleAttribute(attribute) {
  //Toggle strength, Ballance and Flexibility buttons.
  asanas[current][attribute] = ! asanas[current][attribute] ;
  setAttributeButton($("#"+attribute), asanas[current][attribute]); 
  setSaveButton(false);
};


function gotoAsana() {
  var match = $("#theSearchForm input").val().toUpperCase().trim();
  var found = [];
  var matchCallback = function (pre, cur) {
    var strName = cur.name.toUpperCase().trim();
    var strSanskrit = cur.sanskrit.toUpperCase().trim();
      if ((strName.indexOf(match) > -1) || (strSanskrit.indexOf(match) > -1)) {
        pre.push(cur);
        return pre
      } else {
        return pre
      }
  };

  found = asanas.reduce(matchCallback, new Array());
  if (found.length != 0) {
    asanas = found.slice(0);
    current = 0;
    displayAsana();
    setNextPrevStatus()
  }
  return false
}

function clearSearch() {
  $("#theSearchForm input").val("");
  loadAllAsana(0)
}

   </script>
 </body>
</html>


