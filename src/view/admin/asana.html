<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Flow!</title>
    
    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">
    
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/chosen.min.css" rel="stylesheet">
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
	<div class="col-md-12">
	  <div class="page-header">
	    <h1> Flow <small> ... asina for creativity</small> </h1>
	  </div>
	</div>
      </div>
      <div class="row">
	<div class="col-md-12">
	  <h3 class="text-primary text-left"></h3>

          <div class="col-md-4">
	    <h3 class="text-left text-warning"> Enters From</h3>

            <select id="froms" data-placeholder="Choose" style="width:350px;" 
                    multiple class="chosen-select">
            </select>

	  </div>
	<div class="col-md-4">
	  <h3 id="ename" class="text-center text-success"> </h3>
           <div class="btn-group">
	    <button class="btn btn-default" type="button" onclick="toggleAttribute('strength')">
	      <em id="strength" class={% if asana.strength %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Strength
	    </button>
	    <button class="btn btn-default" type="button" onclick="toggleAttribute('ballance')">
	      <em id="ballance" class={% if asana.ballance %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Ballance
	    </button>
	    <button  class="btn btn-default" type="button" onclick="toggleAttribute('flexibility')">
	      <em id="flexibility" class={% if asana.flexibility %} "glyphicon glyphicon-ok" {% else %} "glyphicon glyphicon-remove" {% endif %} ></em> Flexibility
	    </button> 
	  </div>
          
          <div> <img id="pic"  alt="Asana Picture" src={{ path }}></div>
	  <div class="btn-group">
	    <button id="left" class="btn btn-default" type="button" onclick="previous()">
	      <em class="glyphicon glyphicon-chevron-left" ></em> Previous
	    </button>
	    <button id="right" class="btn btn-default" type="button" onclick="next()">
	      <em  class="glyphicon glyphicon-chevron-right" ></em> Next
	    </button>
	    <button id="reset" class="btn btn-default" type="button" onclick="reset()">
	      <em  class="glyphicon glyphicon-refresh" ></em> Reset
	    </button>
	    <button  id="savebutton"class="btn btn-default" type="button" onclick="saveCurrent()">
	      <em  id="save" class="glyphicon glyphicon-saved" ></em> Save
	    </button>
            
	  </div>
	</div>

        <div class="col-md-4">
          <div class="col-md-4">
	    <h3 class="text-left text-warning"> Exits To</h3>

            <select id="tos" data-placeholder="Choose" style="width:350px;" 
                    multiple class="chosen-select">
            </select>

	  </div>
        </div>
        </div>
      </div>
    </div>
    <div class="row">
	<div class="col-md-6">
	  <div class="row">

	  </div>
	  <table id="mg" class="table table-condensed table-striped">
	    <thead>
	      <tr>
	        <th>
		  Major Muscle Groups
	        </th>
	      </tr>
	    </thead>
	    <tbody>
	    </tbody>
	  </table>
	</div>
	<div class="col-md-6">
	  <div class="row">

	  </div>
	  <table id="rom" class="table table-condensed table-striped">
	    <thead>
	      <tr>
	        <th>
		  Joints and Ranges
	        </th>
	      </tr>
	    </thead>
	    <tbody>
	    </tbody>
	  </table>
	</div>
      </div>
      <div class="row">
	<div class="col-md-12">
	</div>
      </div>
    </div>


  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/chosen.jquery.min.js"></script>

  <script>
  $(document).ready(function() {
    loadAllAsana(0);
    setSaveButton(true);
  });

// Attach the chosen jquery plug-in to the select-boxes.


$("#tos").chosen().change(function() {
     setSaveButton(false);
  });

$("#froms").chosen().change(function() {
     setSaveButton(false);
  });

// Asanas is the array of all asanas, current is the index of the current one.
var asanas = new Array();
var currentEnters = new Array();

var current = 0;

function reset() {
  loadAllAsana(current);
};

// Load all asana and set the current asana to be the index, NewCurrent.
function loadAllAsana(NewCurrent) {
  $.ajax("/admin/asana/all",
         { cache: false,
           success: function(data, code, xhr) {
             asanas = data.asanas;
             current = NewCurrent;
             setSaveButton(true);
             displayAsana();
           }})};

function setSaveButton(state) {
  // change icon and text from save to saved and back again.
  // state = true indicates that everything has been saved.
  if (state == true) {
    $("#save").removeClass("glyphicon-save");
    $("#save").addClass("glyphicon-saved");
    $("#savebutton").prop("disabled", state);
    setNextPrevStatus();
  } else {
    $("#save").removeClass("glyphicon-saved");
    $("#save").addClass("glyphicon-save");
    $("#savebutton").prop("disabled", state);
    setNextPrevStatus();
  }};

function saveCurrent() {
  var fs = collectTransitions($("#froms option"));
  var es = collectTransitions($("#tos option"));
  $.post("/admin/asana/update",
         {new_asana:JSON.stringify(asanas[current]),
          from_asanas:JSON.stringify(fs),
          to_asanas:JSON.stringify(es)},
         function(data,status) { });
  setSaveButton(true);
};

function collectTransitions(select) {
  var selected=[];
  for (var i = 0; i < select.length; i++) {
    if (select[i].selected) selected.push(select[i].value);
  }
  return (selected);
};



function next() {
  if (current < asanas.length - 1) {
    current = current + 1;
    displayAsana();
  };
  setNextPrevStatus();
};

function previous() {
  if (current > 0) {
    current = current - 1;
    displayAsana();
  };
  setNextPrevStatus();
};


function setNextPrevStatus() {
  // Determine if the next and previous buttons should be enabled.
  toggleButtonStatus($('#right'), (current == asanas.length - 1));
  toggleButtonStatus($('#left'), (current == 0));
};

function toggleButtonStatus(a_button, state) {
  a_button.prop("disabled", state);
};


function getDetails() {
  $.ajax("/admin/related/" + asanas[current].id,
         { cache: false,
           success: function(data, code, xhr) {
             loadAnatomy(data.mg, '#mg');
             loadAnatomy(data.rom, '#rom');
             loadEntersAndExits(data.enters, $('#froms'));
             loadEntersAndExits(data.exits, $('#tos'));
         }})};


// Load either range of motion or musclegroup tables.
function loadAnatomy(groups, accessor) {
  var Rows = "";
  $(accessor + ' tbody').empty()
  for (i = 0; i < groups.length; i++) {
    Rows = Rows + 
      "<tr class='success'>" +
      "<td>" + groups[i].name + "</td></tr>";
  };
  $(accessor + ' > tbody:last-child').append(Rows);
};

// Load either entering or exiting asana select boxes.
function loadEntersAndExits(enters, control) {
  var Rows = "";
  var Found = new Array();
  
  for (i = 0; i < enters.length; i++) {
    Rows = Rows + 
      '<option value="' + enters[i].id + '" selected>' + 
      enters[i].name + '</option>';
    Found.push(enters[i].id);
  };
  control.html(Rows);

  Rows = "";
  for (i = 0; i < asanas.length; i++) {
    if (Found.indexOf(asanas[i].id) == -1 && i != current) {
      Rows = Rows + 
        '<option value="' + asanas[i].id + '">' + 
        asanas[i].name + '</option>';
    };
  };
  control.append(Rows);
  control.trigger("chosen:updated")
};



function displayAsana() {
  $("#ename").text(asanas[current].name + " - " + asanas[current].sanskrit);
  setAttributeButton($("#strength"), asanas[current].strength); 
  setAttributeButton($("#ballance"), asanas[current].ballance); 
  setAttributeButton($("#flexibility"), asanas[current].flexibility)
  $("#pic").attr('src', "/static/stickfigures/" + asanas[current].name.toLowerCase() + ".jpg");
  getDetails();
}

function setAttributeButton(control, value) {
  if (value) {
    control.removeClass("glyphicon-remove");
    control.addClass("glyphicon-ok")
  } else {
    control.removeClass("glyphicon-ok");
    control.addClass("glyphicon-remove")
  }};


function toggleAttribute(attribute) {
  //Toggle strength, Ballance and Flexibility buttons.
  asanas[current][attribute] = ! asanas[current][attribute] ;
  displayAsana();
  setSaveButton(false);
};


   </script>
 </body>
</html>


